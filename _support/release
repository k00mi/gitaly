#!/usr/bin/env ruby
require 'erb'

require_relative 'run.rb'

GEM_NAME = 'gitaly'

def main(version)
  run!(%w[_support/generate-from-proto])
  run!(%w[make test])
  puts 'Testing for changed files'
  run!(%w[git diff --quiet --exit-code])
  puts 'Testing for staged changes'
  run!(%w[git diff --quiet --cached --exit-code])
  write_version_files(version)
  version_msg = "Version #{version}"
  run!(%W[git commit -m #{version_msg}])
  tag_name = "v#{version}"
  run!(%W[git tag -a -m #{version_msg} #{tag_name}])
  run!(%W[git show --pretty #{tag_name}])
  run!(%W[gem build #{GEM_NAME}.gemspec])
  puts "Proceed to publish version #{version}? Enter 'Yes' to continue; Ctrl-C to abort"
  $stdout.flush
  abort unless $stdin.gets.chomp == 'Yes'
  %w[
    https://gitlab.com/gitlab-org/gitaly.git
    https://dev.gitlab.org/gitlab/gitaly.git
  ].each do |remote|
    run!(%W[git push #{remote} HEAD #{tag_name}])
  end
  run!(%W[gem push #{GEM_NAME}-#{version}.gem])
end

def write_version_files(version)
  version_file = 'VERSION'
  open(version_file, 'w') { |f| f.puts version }
  run!(%W[git add #{version_file}])

  version_rb_template = ERB.new <<EOT
# This file was auto-generated by #{$0}
module Gitaly
  VERSION = "#{version}"
end
EOT
  version_rb = 'protos/ruby/lib/gitaly/version.rb'
  open(version_rb, 'w') { |f| f.write(version_rb_template.result) }
  run!(%W[git add #{version_rb}])
end

def error(msg)
  warn "#{$0}: #{msg}"
end

unless ARGV.count == 1
  warn "Usage: #{$0} VERSION"
  warn "Specify version as x.y.z"
  abort
end

unless File.exist?('.gitaly-root-directory')
  error "#{$0}: this script must be run from the root of the Gitaly repository"
  abort
end

main(ARGV.first)
